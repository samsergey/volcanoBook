<!DOCTYPE html>
<html>
  <head>
    <meta charset='UTF-8'/>
    <script src='../lib/d3.js'></script>
    <script src='../lib/analysis.js'></script>
    <script src='../lib/functions.js'></script>
    <script src='../lib/tools.js'></script>
    <script src='../lib/graphics.js'></script>
    <link rel="stylesheet" href="../css/bw.css">
    <style>
      .queue {
	  stroke-width:0.25px;
      }
    </style>
  </head>
  <body>
    <canvas id='canvas' width='400' height='400'></canvas>
  </body>
  <script>
    var N = 400,i,j;
    var ctx = canvas.getContext('2d');
    ctx.globalAlpha = 0.1
    var imd = ctx.createImageData(N, N);
    var pile = new Array()

    function elevation(i,j)
    {
	return pile[i] && pile[i][j] || 0
    }

    function addTo(i,j,n) {
	if (i <= 0 || i > N || j <= 0 || j > N)
	    return
	if (!pile[i]) pile[i] = new Array()
	pile[i][j] = (pile[i][j] || 0) + n
	if (elevation(i,j) >= 4) enq(i,j)
	put(i,j)
    }

    function set(i,j,n) {
	if (i < 0 || i > N || j < 0 || j > N)
	    return
	if (!pile[i]) pile[i] = new Array()
	pile[i][j] = n
    }

    var que = new Set()
    
    function enq(i,j) {
	que.add(i*N+j)
    }
    function deq(i,j) {
	que.delete(i*N+j)
    }


    function divMod(a,n) {
	return [ Math.floor(a/n), a % n ]
    }
    
    function step() {
	i = Math.round(Math.random()*0)+N/2
	j = Math.round(Math.random()*0)+N/2
	addTo(i,j,1)
	while (que.size  > 0)
	{
	    que.forEach(n => {
		var [i,j] = divMod(n,N) 
		addTo(i,   j, -4)
		if (elevation(i,j)<4)
		    deq(i,j)
		addTo(i-1, j, 1)
		addTo(i, j-1, 1)
		addTo(i+1, j, 1)
		addTo(i, j+1, 1)
	    })
	}
	
    }

    function multistep(n) {
	return () =>
	{
	    for(var i = 0; i < n; i++)
		step()
	    ctx.putImageData(imd, 0, 0);
	}
    }

    function put(i,j) {
	var p = 4*(i*N+j)
	//var c = elevation(i,j) % 3
	imd.data[p+0] = elevation(i,j) / 3 * 255
	imd.data[p+1] = elevation(i,j) / 3 * 255
	imd.data[p+2] = elevation(i,j) / 3 * 255
	imd.data[p+3] = 255
    }
    
    function fade()
    {
	ctx.globalAlpha = 0.01
	ctx.fillStyle = 'white'
	ctx.fillRect(0,0,N,N)
    }

    function show(i,j) {
	ctx.globalAlpha = 0.5
	ctx.fillStyle = color(i,j)
	ctx.fillRect(i,j,1,1)
    }
    
    function color(i,j)
    {
	return ['white','red','blue','yellow'][elevation(i,j)]
    }

    window.setInterval(multistep(1000),1)
  </script>
</html>
